<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amoney Trading Bot</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 12px 20px; border-bottom: 2px solid #00ff88; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo-title { display: flex; align-items: center; gap: 12px; }
        .logo { width: 42px; height: 42px; border-radius: 8px; object-fit: contain; border: 2px solid #00ff88; }
        .header h1 { font-size: 24px; background: linear-gradient(90deg, #00ff88, #00ccff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .asset-selector { display: flex; align-items: center; gap: 12px; }
        .asset-selector label { color: #888; font-size: 13px; }
        .asset-dropdown { background: #1a1a2e; border: 2px solid #00ff88; color: #fff; padding: 10px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; min-width: 200px; font-weight: 600; }
        .asset-dropdown:hover { background: #252540; }
        .payout-badge { background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; }
        .status-bar { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; max-width: 1400px; margin-left: auto; margin-right: auto; padding: 0 20px; }
        .status-item { background: rgba(255,255,255,0.05); padding: 10px 16px; border-radius: 8px; font-size: 13px; }
        .status-item .label { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-item .value { color: #00ff88; font-weight: 700; font-size: 14px; }
        .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 15px; padding: 15px; max-width: 1400px; margin: 0 auto; }
        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
        .card { background: #1a1a1a; border-radius: 12px; padding: 20px; border: 1px solid #333; }
        .card h2 { font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #00ff88; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .timer-box { background: linear-gradient(135deg, #1e1e2e, #2a2a3e); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 15px; border: 2px solid #00ff88; }
        .timer-label { color: #888; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .timer-value { font-size: 48px; font-weight: 700; color: #00ff88; font-family: 'Courier New', monospace; text-shadow: 0 0 20px rgba(0,255,136,0.3); }
        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00ccff); border-radius: 3px; transition: width 0.3s; }
        .chart-section { background: #0d0d0d; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chart-title { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .chart-value { color: #00ff88; font-weight: 700; font-size: 14px; }
        .chart-container { height: 350px; background: #000; border-radius: 8px; margin-bottom: 10px; border: 1px solid #222; }
        .indicators-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .indicator-box { background: #0d0d0d; border-radius: 10px; padding: 12px; border: 1px solid #222; }
        .indicator-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .indicator-name { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .indicator-current { color: #00ff88; font-weight: 700; font-size: 13px; }
        .indicator-chart { height: 120px; background: #000; border-radius: 6px; position: relative; overflow: hidden; }
        .stoch-levels { position: absolute; left: 0; right: 0; top: 0; bottom: 0; pointer-events: none; }
        .stoch-line { position: absolute; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.15); }
        .stoch-line-80 { top: 20%; }
        .stoch-line-50 { top: 50%; }
        .stoch-line-20 { top: 80%; }
        .stoch-label { position: absolute; right: 5px; font-size: 10px; color: #666; }
        .stoch-label-80 { top: 18%; }
        .stoch-label-20 { top: 78%; }
        .signals-container { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; }
        .prediction-banner { background: linear-gradient(135deg, #1e3a5f 0%, #2a5298 100%); border-radius: 10px; padding: 15px; border-left: 4px solid #00ccff; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }
        .prediction-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .prediction-type { background: #00ccff; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .countdown { font-size: 20px; font-weight: 700; color: #00ccff; }
        .signal-card { background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border-radius: 10px; padding: 15px; border-left: 4px solid; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .signal-card.CALL { border-left-color: #00ff88; }
        .signal-card.PUT { border-left-color: #ff4757; }
        .signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .signal-type { font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .signal-type.CALL { color: #00ff88; }
        .signal-type.PUT { color: #ff4757; }
        .confidence-badge { background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: 700; }
        .signal-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 12px 0; }
        .detail-item { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; }
        .detail-item .label { color: #666; font-size: 10px; display: block; text-transform: uppercase; margin-bottom: 4px; }
        .detail-item .value { font-size: 15px; font-weight: 700; color: #fff; }
        .signal-reasons { font-size: 12px; color: #aaa; margin-top: 10px; padding-left: 16px; }
        .signal-reasons li { margin: 4px 0; }
        .martingale-panel { display: flex; flex-direction: column; gap: 12px; }
        .stage-list { display: flex; flex-direction: column; gap: 8px; }
        .stage-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid transparent; }
        .stage-item.active { background: rgba(0,255,136,0.1); border-color: #00ff88; }
        .stage-number { font-weight: 700; font-size: 14px; }
        .stage-amount { font-size: 16px; font-weight: 800; color: #00ff88; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-box.wins { background: rgba(0,255,136,0.1); }
        .stat-box.losses { background: rgba(255,71,87,0.1); }
        .stat-value { font-size: 28px; font-weight: 800; }
        .stat-box.wins .stat-value { color: #00ff88; }
        .stat-box.losses .stat-value { color: #ff4757; }
        .stat-label { font-size: 11px; color: #888; margin-top: 5px; text-transform: uppercase; }
        .controls { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.2s; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, #00ff88, #00cc66); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,255,136,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #333; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); border-color: #555; }
        .connection-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(0,255,136,0.1); border-radius: 20px; font-size: 12px; font-weight: 600; }
        .connection-status::before { content: ''; width: 8px; height: 8px; background: #00ff88; border-radius: 50%; animation: pulse-dot 2s infinite; box-shadow: 0 0 10px #00ff88; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .empty-state svg { width: 60px; height: 60px; margin-bottom: 15px; opacity: 0.5; }
        .legend { display: flex; gap: 20px; margin-top: 10px; font-size: 12px; }
        .user-welcome { color: #00ccff; font-size: 14px; font-weight: 600; }
        .user-id { color: #00ff88; font-weight: 700; }
        .logout-btn {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }
        .admin-link {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.2s;
        }
        .admin-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-title">
                <img src="/logo.png" alt="Logo" class="logo" id="header-logo">
                <h1>Amoney Trading Bot</h1>
            </div>
            <div class="asset-selector">
                <label>Select Asset:</label>
                <select class="asset-dropdown" id="asset-select">
                    <option value="">Loading assets...</option>
                </select>
                <span class="payout-badge" id="payout-display">+92%</span>
            </div>
            <div class="user-welcome" id="user-welcome"></div>
            <a href="/admin" class="admin-link" id="admin-link" style="display: none;">üëë Admin Panel</a>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="status-bar">
        <div class="status-item"><div class="label">Status</div><div class="value connection-status">Live</div></div>
        <div class="status-item"><div class="label">Timeframe</div><div class="value">5 Minutes</div></div>
        <div class="status-item"><div class="label">Next Entry</div><div class="value" id="next-entry">--:--</div></div>
        <div class="status-item"><div class="label">Active Signals</div><div class="value" id="signals-count">0</div></div>
        <div class="status-item"><div class="label">Win Rate</div><div class="value" id="win-rate">--%</div></div>
        <div class="status-item"><div class="label">Current Asset</div><div class="value" id="current-asset-display">--</div></div>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <div class="card">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00ccff" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Predictions & Signals
                </h2>
                <div class="signals-container" id="signals-list">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        <p>Waiting for signals...</p>
                        <p style="font-size: 12px; margin-top: 8px;">The bot monitors ALL assets and picks the best signals automatically</p>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 15px;">
                <div class="timer-box">
                    <div class="timer-label">Next 5-Minute Entry Window</div>
                    <div class="timer-value" id="countdown-timer">05:00</div>
                    <div class="progress-bar"><div class="progress-fill" id="timer-progress" style="width: 0%"></div></div>
                </div>
            </div>

            <div class="card" style="margin-top: 15px;">
                <div class="chart-section">
                    <div class="chart-header">
                        <span class="chart-title">Price Chart with EMA (9/21)</span>
                        <span class="chart-value" id="current-price">--</span>
                    </div>
                    <div class="chart-container" id="price-chart"></div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:#00ccff"></div><span>EMA 9</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#ffaa00"></div><span>EMA 21</span></div>
                    </div>
                </div>
                
                <div class="indicators-row">
                    <div class="indicator-box">
                        <div class="indicator-header">
                            <span class="indicator-name">Stochastic (14,3,3)</span>
                            <span class="indicator-current" id="stoch-current">K: -- | D: --</span>
                        </div>
                        <div class="indicator-chart" id="stochastic-chart">
                            <div class="stoch-levels">
                                <div class="stoch-line stoch-line-80"></div>
                                <div class="stoch-line stoch-line-50"></div>
                                <div class="stoch-line stoch-line-20"></div>
                                <div class="stoch-label stoch-label-80">80</div>
                                <div class="stoch-label stoch-label-20">20</div>
                            </div>
                        </div>
                    </div>
                    <div class="indicator-box">
                        <div class="indicator-header">
                            <span class="indicator-name">RSI (14)</span>
                            <span class="indicator-current" id="rsi-current">--</span>
                        </div>
                        <div class="indicator-chart" id="rsi-chart">
                            <div class="stoch-levels">
                                <div class="stoch-line stoch-line-80"></div>
                                <div class="stoch-line stoch-line-50"></div>
                                <div class="stoch-line stoch-line-20"></div>
                                <div class="stoch-label stoch-label-80">70</div>
                                <div class="stoch-label stoch-label-20">30</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00ccff" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Martingale System
                </h2>
                <div class="martingale-panel" id="martingale-panel">
                    <div class="stage-list" id="stage-list"></div>
                    <div class="stats-grid">
                        <div class="stat-box wins"><div class="stat-value" id="win-count">0</div><div class="stat-label">Wins Today</div></div>
                        <div class="stat-box losses"><div class="stat-value" id="loss-count">0</div><div class="stat-label">Losses Today</div></div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="resetMartingale()">Reset Stage</button>
                        <button class="btn btn-primary" onclick="refreshStatus()">Refresh</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffaa00" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                    üìï Trading Instructions
                </h2>
                <div style="font-size: 13px; line-height: 1.6; color: #ccc;">
                    <p style="background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107; padding: 10px; margin-bottom: 12px; border-radius: 4px;">
                        <strong>‚ùóÔ∏è Important:</strong> Our signals are specifically designed for PocketOption. Using a different broker may yield different results.
                    </p>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">1Ô∏è‚É£ Getting Started</h3>
                    <p>If you don't have a trading account yet, set up one with PocketOption using <a href="https://u3.shortink.io/smart/4jAudmnoq40Qd1" target="_blank" style="color: #00ff88; text-decoration: underline; font-weight: bold;">our registration link</a> to receive $50,000 in demo funds‚Äîrisk-free! Plus, enjoy a 60% bonus on your first deposit!</p>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">üñ•Ô∏è Step 1: Account Setup</h3>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Create your account using <a href="https://u3.shortink.io/smart/4jAudmnoq40Qd1" target="_blank" style="color: #00ff88; text-decoration: underline;">our registration link</a></li>
                        <li>Enter your email and set a password</li>
                        <li>Complete captcha and register for demo ($50,000)</li>
                    </ul>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">üí≥ Step 2: Fund Your Account</h3>
                    <p>Deposit funds via Cryptocurrency or Bank Transfer.</p>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">‚è∞ Step 3: Set Your Time Zone</h3>
                    <p>Change timezone to <strong>UTC -4 (New York time)</strong> for accurate signal sync.</p>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">üîç Step 4: Following Signals</h3>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Watch for signals on this bot dashboard</li>
                        <li>Get real-time updates via our Telegram channel - <a href="https://t.me/amoneytradingsignalbot" target="_blank" style="color: #00ccff; text-decoration: underline; font-weight: bold;">CLICK HERE to join our Telegram channel</a></li>
                        <li>Match trading pairs and expiry times</li>
                        <li>Choose "Higher" (BUY) or "Lower" (SELL)</li>
                        <li>Enter at specified time, monitor until expiration</li>
                    </ul>
                    
                    <h3 style="color: #00ff88; margin: 15px 0 8px; font-size: 14px;">üìà Step 5: Martingale Strategy</h3>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>If you lose, double investment for next trade</li>
                        <li>Follow same direction as losing trade</li>
                        <li>Quick execution is crucial for success</li>
                    </ul>
                    
                    <h3 style="color: #00ccff; margin: 15px 0 8px; font-size: 14px;">‚ÑπÔ∏è Signal Format</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-bottom: 10px;">
                        üá≤üá¶ MAD/USD üá∫üá∏ OTC<br>
                        üïò Expiry: 5 minutes<br>
                        ‚è∫ Entry Time: 17:30<br>
                        üü© BUY<br><br>
                        1Ô∏è‚É£ Level 1: 17:35<br>
                        2Ô∏è‚É£ Level 2: 17:40<br>
                        3Ô∏è‚É£ Level 3: 17:45
                    </div>
                    
                    <p style="margin-top: 15px; text-align: center;">
                        <strong style="color: #00ff88;">‚ùì Questions? Contact <a href="https://t.me/AmoneyTradingBot_Support" target="_blank" style="color: #00ff88; text-decoration: underline;">@AmoneyTradingBot_Support</a></strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let signals = [], predictions = [], martingaleData = null;
        let currentAsset = 'EURUSD OTC', priceChart, stochChart, rsiChart;
        let candleSeries, ema9Series, ema21Series, stochKSeries, stochDSeries, rsiSeries;

        function initCharts() {
            const priceContainer = document.getElementById('price-chart');
            priceChart = LightweightCharts.createChart(priceContainer, {
                width: priceContainer.clientWidth,
                height: priceContainer.clientHeight,
                layout: { background: { color: '#000000' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1a1a1a', style: 2 }, horzLines: { color: '#1a1a1a', style: 2 } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal, vertLine: { color: '#00ff88', style: 3, labelBackgroundColor: '#00ff88' }, horzLine: { color: '#00ff88', style: 3, labelBackgroundColor: '#00ff88' } },
                rightPriceScale: { borderColor: '#333', scaleMargins: { top: 0.1, bottom: 0.1 } },
                timeScale: { borderColor: '#333', timeVisible: true, secondsVisible: false },
                handleScroll: { vertTouchDrag: false },
                handleScale: { axisPressedMouseMove: true }
            });
            
            candleSeries = priceChart.addCandlestickSeries({
                upColor: '#00ff88', downColor: '#ff4757', borderUpColor: '#00ff88', borderDownColor: '#ff4757',
                wickUpColor: '#00ff88', wickDownColor: '#ff4757', priceFormat: { type: 'price', precision: 5, minMove: 0.00001 }
            });
            
            ema9Series = priceChart.addLineSeries({ color: '#00ccff', lineWidth: 2, priceLineVisible: false });
            ema21Series = priceChart.addLineSeries({ color: '#ffaa00', lineWidth: 2, priceLineVisible: false });

            const stochContainer = document.getElementById('stochastic-chart');
            stochChart = LightweightCharts.createChart(stochContainer, {
                width: stochContainer.clientWidth,
                height: stochContainer.clientHeight,
                layout: { background: { color: 'transparent' }, textColor: '#888' },
                grid: { vertLines: { color: 'transparent' }, horzLines: { color: 'transparent' } },
                rightPriceScale: { borderColor: '#333', autoScale: false, scaleMargins: { top: 0, bottom: 0 } },
                timeScale: { visible: false },
                handleScroll: false, handleScale: false
            });
            stochChart.priceScale().applyOptions({ autoScale: false, minValue: 0, maxValue: 100 });
            stochKSeries = stochChart.addLineSeries({ color: '#00ccff', lineWidth: 2, lastValueVisible: true, priceLineVisible: false });
            stochDSeries = stochChart.addLineSeries({ color: '#ff9500', lineWidth: 2, lastValueVisible: true, priceLineVisible: false });

            const rsiContainer = document.getElementById('rsi-chart');
            rsiChart = LightweightCharts.createChart(rsiContainer, {
                width: rsiContainer.clientWidth,
                height: rsiContainer.clientHeight,
                layout: { background: { color: 'transparent' }, textColor: '#888' },
                grid: { vertLines: { color: 'transparent' }, horzLines: { color: 'transparent' } },
                rightPriceScale: { borderColor: '#333', autoScale: false, scaleMargins: { top: 0, bottom: 0 } },
                timeScale: { visible: false },
                handleScroll: false, handleScale: false
            });
            rsiChart.priceScale().applyOptions({ autoScale: false, minValue: 0, maxValue: 100 });
            rsiSeries = rsiChart.addLineSeries({ color: '#00ff88', lineWidth: 2, lastValueVisible: true, priceLineVisible: false });

            window.addEventListener('resize', () => {
                const w = priceContainer.clientWidth;
                const h = priceContainer.clientHeight;
                priceChart.applyOptions({ width: w, height: h });
                stochChart.applyOptions({ width: stochContainer.clientWidth, height: stochContainer.clientHeight });
                rsiChart.applyOptions({ width: rsiContainer.clientWidth, height: rsiContainer.clientHeight });
            });
        }

        function updateCountdown() {
            const now = new Date();
            const minutes = now.getMinutes();
            const next5Min = Math.ceil(minutes / 5) * 5;
            let targetTime = new Date(now);
            if (next5Min === 60) { targetTime.setHours(targetTime.getHours() + 1); targetTime.setMinutes(0); }
            else { targetTime.setMinutes(next5Min); }
            targetTime.setSeconds(0);
            const diff = targetTime - now;
            const minLeft = Math.floor(diff / 60000);
            const secLeft = Math.floor((diff % 60000) / 1000);
            document.getElementById('countdown-timer').textContent = String(minLeft).padStart(2, '0') + ':' + String(secLeft).padStart(2, '0');
            document.getElementById('timer-progress').style.width = ((5 - minLeft - secLeft/60) / 5 * 100) + '%';
            document.getElementById('next-entry').textContent = targetTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateCountdown, 1000);
        updateCountdown();

        document.getElementById('asset-select').addEventListener('change', function() {
            currentAsset = this.value;
            const payout = this.options[this.selectedIndex].dataset.payout || 92;
            document.getElementById('payout-display').textContent = '+' + payout + '%';
            document.getElementById('current-asset-display').textContent = currentAsset;
            candleSeries.setData([]);
            ema9Series.setData([]);
            ema21Series.setData([]);
            stochKSeries.setData([]);
            stochDSeries.setData([]);
            rsiSeries.setData([]);
            console.log('Asset changed to:', currentAsset);
        });

        socket.on('connect', () => console.log('Connected'));
        socket.on('initial-data', (data) => {
            if (data.signals) { signals = data.signals; renderSignals(); }
            if (data.martingale) updateMartingale(data.martingale);
        });
        socket.on('new-signal', (data) => {
            if (data.signal) { signals.unshift(data.signal); if (signals.length > 20) signals.pop(); renderSignals(); }
            if (data.martingale) updateMartingale(data.martingale);
        });
        socket.on('trade-result', () => fetchStats());
        socket.on('price-update', (data) => { 
            if (data.asset === currentAsset) updateChart(data.candle, data.indicators);
        });

        function updateChart(candle, indicators) {
            const time = candle.timestamp / 1000;
            candleSeries.update({ time, open: candle.open, high: candle.high, low: candle.low, close: candle.close });
            document.getElementById('current-price').textContent = candle.close.toFixed(5);
            if (indicators) {
                if (indicators.ema9) ema9Series.update({ time, value: indicators.ema9 });
                if (indicators.ema21) ema21Series.update({ time, value: indicators.ema21 });
                if (indicators.stochK !== undefined) {
                    stochKSeries.update({ time, value: indicators.stochK });
                    stochDSeries.update({ time, value: indicators.stochD || indicators.stochK });
                    document.getElementById('stoch-current').textContent = 'K: ' + indicators.stochK.toFixed(2) + ' | D: ' + (indicators.stochD || indicators.stochK).toFixed(2);
                }
                if (indicators.rsi !== undefined) {
                    rsiSeries.update({ time, value: indicators.rsi });
                    document.getElementById('rsi-current').textContent = indicators.rsi.toFixed(2);
                }
            }
        }

        function renderSignals() {
            const container = document.getElementById('signals-list');
            if (signals.length === 0 && predictions.length === 0) return;
            let html = '';
            predictions.forEach(pred => {
                html += '<div class="prediction-banner"><div class="prediction-header"><span class="prediction-type">PREDICTION</span><span class="countdown">-' + pred.minutesAhead + 'm</span></div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><span style="font-size:16px;font-weight:700;">' + pred.asset + '</span><span style="color:#00ccff;font-weight:700;">' + pred.predictedDirection + ' ' + pred.predictionConfidence + '%</span></div><div style="font-size:12px;color:#aaa;margin-top:6px;">Entry at ' + pred.predictedEntryTime + '</div></div>';
            });
            signals.forEach(sig => {
                const emoji = sig.direction === 'CALL' ? 'UP' : 'DOWN';
                const colorClass = sig.direction === 'CALL' ? '#00ff88' : '#ff4757';
                html += '<div class="signal-card ' + sig.direction + '"><div class="signal-header"><div class="signal-type ' + sig.direction + '">' + emoji + ' ' + sig.direction + '</div><div class="confidence-badge" style="color:' + colorClass + '">' + sig.confidence + '%</div></div><div class="signal-details"><div class="detail-item"><span class="label">Asset</span><span class="value">' + sig.asset + '</span></div><div class="detail-item"><span class="label">Entry</span><span class="value">' + sig.entryTime + '</span></div><div class="detail-item"><span class="label">Payout</span><span class="value" style="color:#00ff88">+' + (sig.payout || 92) + '%</span></div></div></div>';
            });
            container.innerHTML = html;
            document.getElementById('signals-count').textContent = signals.length;
        }

        function updateMartingale(data) {
            martingaleData = data;
            const stageList = document.getElementById('stage-list');
            if (data.stages) stageList.innerHTML = data.stages.map(stage => '<div class="stage-item ' + (stage.current ? 'active' : '') + '"><span class="stage-number">Stage ' + stage.stage + '</span><span class="stage-amount">$' + stage.amount + '</span></div>').join('');
            if (data.winCount !== undefined) document.getElementById('win-count').textContent = data.winCount;
            if (data.lossCount !== undefined) document.getElementById('loss-count').textContent = data.lossCount;
            updateStats();
        }

        function updateStats() {
            if (!martingaleData) return;
            const total = martingaleData.winCount + martingaleData.lossCount;
            document.getElementById('total-trades').textContent = total;
            const pnl = (martingaleData.dailyStats?.totalProfit || 0) - (martingaleData.dailyStats?.totalLoss || 0);
            const pnlEl = document.getElementById('net-pnl');
            pnlEl.textContent = (pnl >= 0 ? '+' : '-') + '$' + Math.abs(pnl).toFixed(2);
            pnlEl.style.color = pnl >= 0 ? '#00ff88' : '#ff4757';
            if (total > 0) {
                const winRate = Math.round((martingaleData.winCount / total) * 100);
                document.getElementById('win-rate').textContent = winRate + '%';
                document.getElementById('win-rate-text').textContent = winRate + '%';
                document.getElementById('win-rate-bar').style.width = winRate + '%';
            }
        }

        function resetMartingale() {
            fetch('/api/martingale/reset', { method: 'POST' }).then(r => r.json()).then(data => updateMartingale(data));
        }
        
        function fetchStats() {
            fetch('/api/stats').then(r => r.json()).then(stats => {
                if (stats.wins !== undefined) {
                    document.getElementById('win-count').textContent = stats.wins;
                    document.getElementById('loss-count').textContent = stats.losses;
                }
                const total = stats.wins + stats.losses;
                document.getElementById('total-trades').textContent = total;
                if (total > 0) {
                    const winRate = Math.round((stats.wins / total) * 100);
                    document.getElementById('win-rate').textContent = winRate + '%';
                    document.getElementById('win-rate-text').textContent = winRate + '%';
                    document.getElementById('win-rate-bar').style.width = winRate + '%';
                }
            });
        }
        
        function refreshStatus() {
            fetch('/api/martingale').then(r => r.json()).then(data => updateMartingale(data));
            fetchStats();
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        initCharts();
        fetch('/api/status').then(r => r.json()).then(data => {
            const select = document.getElementById('asset-select');
            select.innerHTML = '<option value="">-- Select Asset --</option>';
            const assets = data.assets || ['EURUSD OTC', 'GBPUSD OTC', 'USDJPY OTC', 'USDZAR OTC', 'USDRUB OTC', 'EURCHF OTC', 'EURJPY OTC', 'EURTRY OTC'];
            assets.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset; option.textContent = asset; option.dataset.payout = '92';
                select.appendChild(option);
            });
            if (assets.length > 0) { 
                select.value = assets[0]; 
                currentAsset = assets[0];
                document.getElementById('current-asset-display').textContent = currentAsset;
            }
            if (data.user) {
                document.getElementById('user-welcome').innerHTML = 'Welcome <span class="user-id">' + data.user.tradeId + '</span>';
                if (data.user.isAdmin) {
                    document.getElementById('admin-link').style.display = 'inline-block';
                }
            }
        });
        refreshStatus();
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
